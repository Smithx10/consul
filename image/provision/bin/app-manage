#!/bin/bash

source /usr/local/lib/common-app.sh
set +u
# Template /etc/consul/consul/json
preConsulAgent() {
    if [ -n "$CONSUL_DATACENTER_NAME" ]; then
        _log "Updating consul datacenter name (specified: '${CONSUL_DATACENTER_NAME}' )"
        sed -i "s/CONSUL_DATACENTER_NAME/${CONSUL_DATACENTER_NAME}/" /config/consul.json
    else
        _log "Updating consul datacenter name (default: 'dc1')"
        sed -i "s/CONSUL_DATACENTER_NAME/dc1/" /config/consul.json
    fi

    if [ -n "${CONSUL_SERF_LAN_PORT}" ]; then
        _log "Updating consul serf_lan_port (specified: '${CONSUL_SERF_LAN_PORT}' )"
        sed -i "s/CONSUL_SERF_LAN_PORT/${CONSUL_SERF_LAN_PORT}/" /config/consul.json
    else
        _log "Updating consul serf_lan_port (default: '8301')"
        sed -i "s/CONSUL_SERF_LAN_PORT/8301/" /config/consul.json
    fi

    if [ -n "${CONSUL_SERF_WAN_PORT}" ]; then
        _log "Updating consul serf_wan_port (specified: '${CONSUL_SERF_WAN_PORT}' )"
        sed -i "s/CONSUL_SERF_WAN_PORT/${CONSUL_SERF_WAN_PORT}/" /config/consul.json
    else
        _log "Updating consul serf_wan_port (default: '8302')"
        sed -i "s/CONSUL_SERF_WAN_PORT/8302/" /config/consul.json
    fi
}

# consul-agent Health Check
consulAgentHealth () {
    local status=$(curl -Lsf localhost:8500/v1/health/node/${HOSTNAME}  | jq -r '.[] | select( ."CheckID" == "serfHealth" ) | .Status')
    if [[ "${status}" == "passing" ]]; then
        _log "Consul-Agent health: ${status}"
        return 0
    else
        _log "Consul-Agent health: ${status}"
        return 1
    fi
}


# Run Node Exporter
runNodeExporter() {
    _log "Starting the Prometheus Node_Exporter"
    /usr/local/bin/node_exporter
}

# Node Exporter healthcheck
nodeExporterHealth() {
    curl -Lsf -o /dev/null localhost:9100/metrics
}

#Consul Metric Health Check
consulMetricsHealth() {
    _log "health checking Consul metrics on :::8500/v1/agent/metrics"
    curl -Lsf -o /dev/null localhost:8500/v1/agent/metrics
}

$@
