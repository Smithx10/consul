apiVersion: apps/v1
kind: Deployment
metadata:
  name: consul
spec:
  replicas: 3
  selector:
    matchLabels:
      app: consul
    matchExpressions:
      - {key: app, operator: In, values: [consul]}
  template:
    metadata:
      annotations:
        package: 9cd95f47-11ea-4f61-c323-fe526fc1c544
        networks: "a0ae9499-b476-4fef-9861-d0c25029378d, 17d7aa50-6ad9-4e56-93b7-12dc868fac2a"
        fwgroup: "consul"
        fwenabled: "true"
        affinity: "role!=consul"
        foo: bar
        bar: baz
      labels:
        app: consul
        triton.cns.services: consul
    spec:
      restartPolicy: Always
      containers:
      - image: c239a01f-5fe9-456f-8f92-53f5b7efd53d
        name: consul
        ports:
          - containerPort: 8500
            protocol: TCP
            name: consul
          - containerPort: 22
            name: ssh
        envFrom:
          - configMapRef:
              name: myconfig
        env:
        - name: SECRET_USERNAME
          valueFrom:
           secretKeyRef:
              name: bob
              key: username
        - name: SECRET_PASSWORD
          valueFrom:
            secretKeyRef:
              name: bob
              key: password
        - name: FOO
          valueFrom:
            configMapKeyRef:
              name: consul-config
              key: foo
        - name: CONFIG_VAR
          valueFrom:
            configMapKeyRef:
              name: consul-config
              key: consul-config  
        - name: CONTAINERPILOT
          value: "/etc/containerpilot.json5"
        - name: CONSUL_AGENT 
          value: "1"
        - name: CONSUL_BOOTSTRAP_EXPECT
          value: "3"
        - name: CONSUL
          value: "consul-demo.consul.svc.smith.us-east-1.cns.smithp4ntz.us"
        - name: NODE_EXPORTER
          value: "1"
        readinessProbe:
          httpGet:
            path: /ui
            port: 8500
          initialDelaySeconds: 30
          periodSeconds: 15
        livenessProbe:
          httpGet:
            path: /ui
            port: 8500
          initialDelaySeconds: 60
          periodSeconds: 15
        #livenessProbe:
          #tcpSocket:
            #port: 22
          #initialDelaySeconds: 10
          #periodSeconds: 5
      nodeSelector:
        kubernetes.io/role: agent
        beta.kubernetes.io/os: linux
        type: virtual-kubelet
      tolerations:
      - key: virtual-kubelet.io/provider
        operator: Exists
